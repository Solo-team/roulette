generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               BigInt      @id
  username         String?
  firstName        String
  photoUrl         String?
  coins            Int         @default(0)
  totalDonatedTon  Float       @default(0)
  walletAddress    String?
  lastClaimAt      DateTime?
  referrerId       BigInt?
  referralEarnings Float       @default(0)
  referrer         User?       @relation("Referrals", fields: [referrerId], references: [id])
  referrals        User[]      @relation("Referrals")
  completedTasks   UserTask[]
  gifts            Gift[]
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@index([coins(sort: Desc)])
}

/// Telegram-гифт, отправленный пользователем на профиль бота
model Gift {
  id           String   @id @default(cuid())
  userId       BigInt
  user         User     @relation(fields: [userId], references: [id])
  tgGiftId     String                   // Telegram gift.id
  thumbnailUrl String?                  // URL превью стикера (резолвится при получении)
  emoji        String?                  // emoji стикера, fallback для отображения
  starCount    Int      @default(0)     // стоимость гифта в Stars
  isUpgraded   Boolean  @default(false)
  receivedAt   DateTime @default(now())

  @@index([userId])
}

model UserTask {
  userId      BigInt
  taskId      String
  claimedAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])

  @@id([userId, taskId])
}

/// Заглушки для лидерборда, пока реальных < 100
model BotUser {
  id        Int    @id @default(autoincrement())
  name      String
  coins     Int
  avatarUrl String
}

/// Обработанные TON-транзакции (идемпотентность + защита от повторных зачислений)
model ProcessedTx {
  txHash    String   @id
  userId    BigInt
  amountTon Float
  createdAt DateTime @default(now())
}

/// Обработанные Telegram update_id (идемпотентность Stars-платежей)
model ProcessedUpdate {
  updateId  BigInt   @id
  createdAt DateTime @default(now())
}
